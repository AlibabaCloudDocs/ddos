# 添加规则

非网站业务（例如端游、手游、App等）接入DDoS高防时，您必须在DDoS高防的端口接入页面为业务添加转发规则。端口接入页面也是DDoS高防网络四层防护设置的入口，您可以根据需要为已添加的转发规则设置会话保持、健康检查、DDoS防护策略。

## 前提条件

已开通DDoS高防（新BGP）或DDoS高防（国际）实例。更多信息，请参见[开通DDoS高防（新BGP&国际）](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/开通DDoS高防（新BGP&国际）.md)。

## 添加转发规则

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部菜单栏，选择服务所在地域：

    -   **中国内地**：DDoS高防（新BGP）服务
    -   **非中国内地**：DDoS高防（国际）服务
    您可以通过切换地域分别管理和配置DDoS高防（新BGP）和DDoS高防（国际）实例。在使用DDoS高防服务时，请确认您已选择正确的地域。

3.  在左侧导航栏，单击**接入管理** \> **端口接入**。

4.  在**端口接入**页面，选择要操作的DDoS高防实例，并单击**添加规则**。

    **说明：** 您也可以使用批量操作添加规则，支持一次添加多条规则，具体请参见[批量添加规则](#section_mcd_7yq_9rx)。

    （添加网站）自动生成转发规则：

    转发协议后有![叹号](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4101359951/p128503.png)图标的规则是通过域名接入添加网站后（详见[添加网站](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/网站配置/添加网站.md)）自动生成的转发规则，用来转发网站流量。

    -   如果网站信息中的服务器端口为80，则自动生成一条转发协议为TCP、转发端口为80的转发规则。
    -   如果网站信息中的服务器端口为443，则自动生成一条转发协议为TCP、转发端口为443的转发规则。
    如果上述转发规则已经由其他网站配置自动生成，则再次添加网站时不会重复生成同样的转发规则。

    ![转发规则冲突](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4101359951/p46883.png)

    **说明：** 通过网站配置自动生成的转发规则不支持编辑和删除，无需您进行手动操作。当使用该转发规则的所有网站配置取消与当前DDoS高防实例的关联后，系统生成的转发规则将会被自动删除。

5.  在添加规则对话框，根据您的实际业务情况完成规则配置，并单击**完成**。

    ![规则配置](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/3101359951/p46880.png)

    |参数|描述|
    |--|--|
    |**转发协议**|转发协议类型，可选值：**TCP**、**UDP。**|
    |**转发端口**|DDoS高防实例使用的转发端口。 **说明：**

    -   为了便于管理，建议您将**转发端口**与**源站端口**保持一致。
    -   为了防止私自搭建DNS防护服务器，DDoS高防不支持53端口的端口接入配置。
    -   不允许使用已配置的转发端口。同一DDoS高防实例和转发协议下，每条转发规则的转发端口必须唯一。当您尝试添加同协议-同转发端口的规则时，系统将提示转发规则冲突。请注意不要与通过网站配置自动生成的转发规则冲突，具体请参见[（添加网站）自动生成转发规则](#step_p2d_akc_br3)。 |
    |**源站端口**|源站使用的业务端口。|
    |**源站IP**|源站的IP地址。 **说明：** 支持添加多个源站IP以实现自动负载均衡。多个IP间以英文逗号（,）分隔。最多可配置20个源站IP。 |

    成功添加转发规则后，您可以在**端口接入**页面的转发规则列表中查看转发规则，或者执行以下操作：

    -   为转发规则配置DDoS四层防护设置，例如DDoS防护策略、健康检查、会话保持。更多信息，请参见[配置转发策略](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/快速入门/防护非网站业务/步骤2：设置端口转发和防护策略.md)。
    -   编辑、删除转发规则。更多信息，请参见[编辑规则](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/端口接入/编辑规则.md)、[删除规则](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/端口接入/删除规则.md)。
    -   批量导出规则和防护设置。更多信息，请参见[批量导出](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/端口接入/批量导出.md)。

## 批量添加规则

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部菜单栏，选择服务所在地域：

    -   **中国内地**：DDoS高防（新BGP）服务
    -   **非中国内地**：DDoS高防（国际）服务
    您可以通过切换地域分别管理和配置DDoS高防（新BGP）和DDoS高防（国际）实例。在使用DDoS高防服务时，请确认您已选择正确的地域。

3.  在左侧导航栏，单击**接入管理** \> **端口接入**。

4.  在端口接入页面，选择要操作的DDoS高防实例，并单击规则列表下方的**批量操作** \> **添加规则**。

5.  在添加规则对话框，按照格式要求填入要添加的规则配置，并单击**确定**。

    ![添加规则](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/3101359951/p67614.png)

    规则配置的格式要求如下。

    -   每行对应一条规则。
    -   每条规则包含四个字段，从左到右依次是协议、转发端口、源站端口、源站IP（字段的含义请参见[规则配置描述](#table_cmg_aw2_bd3)），字段间以空格分隔。
6.  在添加规则对话框，选中要上传的规则，并单击**上传**。

    ![确认上传](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/3101359951/p67617.png)

7.  成功上传转发规则后，关闭添加规则对话框。


## 后续操作

添加转发规则后，您还需要执行以下操作，才能完成非网站业务的接入：

1.  在源站服务器上设置放行DDoS高防的回源IP，避免DDoS高防转发回源站的流量被源站服务器上的安全软件拦截。更多信息，请参见[放行DDoS高防回源IP](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/放行DDoS高防回源IP.md)。
2.  通过本地计算机验证转发规则配置已经生效，避免转发规则配置不正确导致业务异常。更多信息，请参见[本地验证转发配置生效](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/网站配置/本地验证转发配置生效.md)。

    **警告：** 如果转发规则未生效就执行业务切换，将可能导致业务中断。

3.  将非网站业务的业务流量切换到DDoS高防实例。具体分为以下两种情况：
    -   如果您的业务直接通过IP进行访问，您只需将业务IP替换为DDoS高防实例的独享IP，即可正式将业务流量切换至DDoS高防实例。

        **说明：** 因为具体操作取决于您的业务开发平台，此处不做详细描述。

    -   如果您的业务中同时使用域名来指定服务器地址（例如，游戏客户端中设置“aliyundemo.com”域名作为服务器地址，或该域名已经写在客户端程序中），则您需要在域名的DNS解析服务提供商处修改DNS解析，将该域名的A记录指向DDoS高防实例的独享IP。更多信息，请参见[修改DNS解析](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/业务接入配置/修改DNS解析接入网站业务.md)。

