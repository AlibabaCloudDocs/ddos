# 配置健康检查

DDoS高防为已接入防护的非网站业务提供网络四层和七层健康检查功能，适用于业务有多个源站IP时，判断后端服务器的业务可用性。在DDoS高防实例下添加端口转发规则后，您可以为转发规则开启健康检查。

-   已在端口接入中配置非网站业务端口转发规则。

    更多信息，请参见[添加规则](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/端口接入/添加规则.md)。

-   端口转发规则中配置了多个源站IP地址。

    **说明：** 如果在端口转发规则中仅配置了一个源站IP，请不要开启健康检查。


健康检查适用于配置了多个源站IP的业务。DDoS高防在转发业务流量回源时，通过健康检查判断源服务器的业务可用性，将流量优先转发到状态健康的源服务器，保证业务正常响应。更多信息，请参见[负载均衡健康检查概述](/intl.zh-CN/传统型负载均衡CLB/用户指南/健康检查/健康检查概述.md)。

## 开启健康检查

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部菜单栏左上角处，选择服务所在地域：

    -   **中国内地**：选择该地域将跳转到**DDoS高防（新BGP）**控制台。
    -   **非中国内地**：选择该地域将跳转到**DDoS高防（国际）**控制台。
    您可以通过切换地域分别管理和配置DDoS高防（新BGP）和DDoS高防（国际）实例。在使用DDoS高防服务时，请确认您已选择正确的地域。

3.  在左侧导航栏，选择**接入管理** \> **端口接入**。

4.  在**端口接入**页面，选择DDoS高防实例，并定位到要操作的转发规则，单击**健康检查**列下的**配置**。

    **说明：** 您也可以在DDoS高防实例下使用批量操作，批量修改会话保持和健康检查配置。具体操作，请参见[批量添加会话和健康检查配置](#section_2o8_zof_4gn)。

    ![健康检查](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5302247061/p69505.png)

5.  在**健康检查**对话框，完成健康检查配置，并单击**完成**。

    ![健康检查](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4741919951/p49648.png)

    DDoS高防支持网络四层和七层健康检查配置，具体参数描述如下表所示。

    **说明：** 四层健康检查和七层健康检查均支持高级设置。高级设置仅在展开**高级设置**后显示。一般情况下，建议您不要修改高级设置。

    |类型|参数|说明|
    |--|--|--|
    |**四层健康检查**|**检查端口**|健康检查服务访问后端服务器时的探测端口。取值范围：1~65535。默认值为配置监听时指定的后端端口。 **说明：** 适用于TCP和UDP协议规则。 |
    |**七层健康检查**|**域名**、**检查路径**|七层健康检查默认由高防转发系统向该服务器应用配置的缺省首页发起HTTP HEAD请求。 **说明：** 仅适用TCP协议规则（HTTP业务）。

如果您用来进行健康检查的页面并不是应用服务器的缺省首页，需要指定域名和具体的检查路径。

如果您对HTTP HEAD请求限定了host字段的参数，您只需要指定检查路径，即用于健康检查页面文件的URI。域名不用填写，默认为后端服务器的IP。 |
    |**检查端口**|健康检查服务访问后端服务器时的探测端口。取值范围：1~65535。默认值为配置监听时指定的后端端口。|
    |**高级设置**|**响应超时时间**|每次健康检查响应的最大超时时间。取值范围：1~30，单位：秒。如果后端服务器在指定的时间内没有正确响应，则判定为健康检查失败。|
    |**检查间隔**|进行健康检查的时间间隔。取值范围：1~30，单位：秒。 **说明：** 高防集群内所有节点都会独立、并行地遵循该属性对后端服务器进行健康检查。由于各高防节点的检查时间并不同步，如果从后端某一服务器上进行单独统计，会发现来自高防IP的健康检查请求在时间上没有遵循指定的时间间隔。 |
    |**不健康阈值**|同一高防节点服务器针对同一后端服务器，在健康检查状态为成功时，连续多少次健康检查失败后，状态判定为失败。取值范围：1~10，单位：次。|
    |**健康阈值**|同一高防节点服务器针对同一后端服务器，在健康检查状态为失败时，连续多少次健康检查成功，状态判定为成功。取值范围：1~10，单位：次。|

    成功开启健康检查后，端口转发规则的**健康检查**状态更新为**已开启**。

    ![已开启（健康检查）](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5302247061/p190039.png)


## 批量添加会话和健康检查配置

1.  登录[DDoS高防控制台](https://yundun.console.aliyun.com/?p=ddoscoo)。

2.  在顶部菜单栏左上角处，选择服务所在地域：

    -   **中国内地**：选择该地域将跳转到**DDoS高防（新BGP）**控制台。
    -   **非中国内地**：选择该地域将跳转到**DDoS高防（国际）**控制台。
    您可以通过切换地域分别管理和配置DDoS高防（新BGP）和DDoS高防（国际）实例。在使用DDoS高防服务时，请确认您已选择正确的地域。

3.  在左侧导航栏，选择**接入管理** \> **端口接入**。

4.  在**端口接入**页面，选择要操作的DDoS高防实例，并在规则列表下方选择**批量操作** \> **添加会话/健康检查配置**。

    ![添加会话和健康检查配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5302247061/p190055.png)

5.  在**添加会话/健康检测配置**对话框，按照格式要求输入要添加的会话保持和健康检查配置内容，并单击**确定**。

    ![添加会话/健康配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5302247061/p69485.png)

    **说明：** 您也可以先批量导出当前会话和健康检查配置，在导出的TXT文件中统一调整后再将内容复制粘贴进来。更多信息，请参见[批量导出](/intl.zh-CN/DDoS高防（新BGP&国际）用户指南/接入DDoS高防/端口接入/批量导出.md)。

    会话保持、健康检查配置的格式要求如下：

    -   每行对应一条转发规则的会话保持和健康配置。
    -   每条会话保持和健康检查配置从左到右包含以下字段：转发协议端口、转发协议（取值：TCP、HTTP、UDP）、会话保持超时时间（单位：秒，取值范围：30~3600）、健康检查类型、检查端口、检查超时时间、检查间隔、不健康阈值、健康阈值、检查路径（转发协议为HTTP时必选）、域名（转发协议为HTTP时可选）。字段间以空格分隔。
    -   转发协议端口必须是已添加规则的端口。
    -   转发规则协议为UDP时，建议配置UDP健康检查。转发规则协议为TCP时，建议配置TCP（四层）或HTTP（七层）健康检查。
    -   转发协议为HTTP时，检查路径必选，域名可选。

