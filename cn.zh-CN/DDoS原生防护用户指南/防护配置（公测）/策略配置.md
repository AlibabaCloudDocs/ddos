# 策略配置

云资产IP添加原生防护后，您可以根据自身业务特征和需求配置防护策略，放行或丢弃包含指定特征的业务流量，提升DDoS防护效果。

-   已创建原生防护企业版实例。

    更多信息，请参见[开通DDoS原生防护企业版](/cn.zh-CN/DDoS原生防护用户指南/开通DDoS原生防护企业版.md)。

    **说明：** 目前防护配置功能在免费公测，已购买原生防护企业版实例的用户可以提交[工单](https://selfservice.console.aliyun.com/ticket/category/ddos_basic/today)开通防护配置功能。

-   云资产IP已经添加原生防护。

    更多信息，请参见[添加防护对象](/cn.zh-CN/DDoS原生防护用户指南/实例管理/添加防护对象.md)。


## 配置流程

首次使用策略配置功能时，推荐您参照以下流程进行操作：

1.  [新建一个策略模板](#step_hep_jau_gt0)。
2.  [为策略模板设置生效资产](#step_6vt_13b_kku)，即在哪些资产上应用当前策略模板。
3.  为策略模板配置具体的防护策略。已配置的防护策略将在上一步设置的资产上生效。

    下表描述了支持配置的防护策略。

    |策略名称|说明|配置方法|
    |----|--|----|
    |**ICMP协议禁用**|在流量清洗时直接丢弃ICMP协议流量，可以过滤ICMP攻击，并减少服务器被探测的风险。|通过单击**状态**开关，开启或关闭**ICMP协议禁用**。开启该策略后，ICMP协议流量将被直接丢弃。**说明：** ICMP协议禁用对白名单中IP也会生效，即开启该策略后，来自白名单IP的ICMP协议流量也会被丢弃。

具体操作请参见[配置ICMP协议禁用策略](#step_ix7_v36_1jd)。 |
    |**源端口封禁**|针对UDP或TCP协议+源或目的端口设置过滤规则，直接丢弃来自指定协议及对应端口的流量，可以用于过滤UDP反射攻击。|需要配置规则，指定要封禁的协议及对应端口。规则生效后，禁用协议+端口的请求流量将被直接丢弃。具体操作请参见[配置源端口封禁规则。](#step_nzj_kye_q9b) |
    |**黑白名单**|针对源IP设置过滤或放行规则，直接丢弃或放行指定源IP的流量。|需要配置黑名单、白名单，分别指定黑名单IP、白名单IP。配置生效后，黑名单IP的请求流量将被直接丢弃，白名单IP的请求流量将被直接放行。具体操作请参见[配置黑白名单](#step_hrk_q19_il7)。 |
    |**指纹过滤**|在流量清洗时，对数据包中指定位置的内容进行特征匹配，根据匹配结果设置过滤、放行或限速规则。|需要配置规则，指定要检测的数据包特征。匹配中特征的请求将触发规则对应的动作，例如通过、丢弃或限速。具体操作请参见[配置指纹过滤特征](#step_04s_c8l_sik)。 |


## 操作步骤

1.  登录[DDoS防护产品控制台](https://yundun.console.aliyun.com/?p=ddos)。

2.  在左侧导航栏，单击**DDoS原生防护** \> **防护配置**。

3.  单击**策略配置**页签。

4.  选择或新建一个策略模板。

    -   如果您已经创建过策略模板，在左侧**策略模板**列表单击要操作的策略模板。
    -   如果您从未创建过策略模板，参照以下步骤创建一个策略模板：
    1.  在左侧**策略模板**列表上方，单击**添加策略**。

    2.  在**添加**对话框，输入**策略名**，并单击**确定**。

        ![添加策略模板](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169416.png)

        成功创建策略模板后，新建的策略模板将被默认选中。

5.  添加生效资产。

    1.  在右侧**生效资产列表**区域，单击**添加IP**。

    2.  在**添加IP**页面，选择要应用当前策略模板的资产IP。

        ![添加IP](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4649670061/p168904.png)

        |参数|说明|
        |--|--|
        |**区域选择**|资产IP所在地域。|
        |**原生防护实例**|资产IP关联的原生防护实例。|
        |**IP选择**|资产IP。**说明：** 一个资产IP只允许关联一个策略模板。如果资产IP已经关联了其他策略模板，则不允许添加到当前策略模板。 |

    3.  单击**确定**。

    成功添加生效资产后，资产IP的流量将受当前策略模板中防护策略的约束。新建的策略模板默认未开启任何防护策略，您需要进一步配置具体的防护策略，才能实现特定的防护效果。

    您可以在**生效资产列表**中**移出**已有资产。

6.  配置**ICMP协议禁用**策略。

    您可以参照以下步骤开启、关闭**ICMP协议禁用**策略：

    1.  在**ICMP协议禁用**区域，单击**状态**开关。

        ![ICMP协议禁用 ](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169426.png)

    2.  在**确认**对话框，单击**确定**。

7.  配置**源端口封禁**规则。

    您可以参照以下步骤配置源端口封禁规则：

    1.  在**源端口封禁**区域，单击**设置**。

        ![源端口封禁 ](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169427.png)

    2.  在**封禁端口**页面，单击**添加端口**。

        **说明：** 最多支持添加8条端口规则。

    3.  在**新增禁用端口**页面，完成以下规则配置。

        ![新增禁用端口](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169430.png)

        |参数|说明|
        |--|--|
        |**协议**|要封禁的协议类型。可选值：**TCP**、**UDP**。|
        |**端口类型**|要封禁的端口类型。可选值：**源端口**、**目的端口**。|
        |**开始端口 — 结束端口**|要封禁的端口范围。可选范围：1~65535。**说明：** 同一协议下相同类型端口的范围不允许重合。 |
        |**匹配后动作**|匹配中协议及对应端口后，对流量执行的操作。取值固定为**丢弃**。|

    4.  单击**确定**。

        成功添加端口封禁规则后，规则自动生效，禁用协议+端口的请求流量将被直接丢弃。您可以在**禁用端口**列表中管理已有规则，例如**编辑**、**删除**规则。

8.  配置黑白名单。

    您可以参照以下步骤配置黑白名单：

    1.  在**黑白名单**区域，单击**设置**。

        ![黑白名单 ](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169428.png)

    2.  在**黑白名单库**页面，单击**添加黑白名单**。

    3.  在**添加黑白名单**页面，完成黑白名单配置。

        最多允许添加10,000个黑名单IP和10,000个白名单IP，多个IP间需要使用空格或者换行符进行分隔。

        ![添加黑白名单](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169431.png)

    4.  单击**确定**。

        成功添加黑白名单后，黑白名单设置自动生效，黑名单IP的请求流量将被直接丢弃，白名单IP的请求流量将被直接放行。您可以在**黑白名单库**管理已有黑名单IP、白名单IP，例如**删除**已添加的IP或者**清空黑名单**、**清空白名单**。

9.  配置指纹过滤特征。

    您可以参照以下步骤配置指纹过滤特征：

    1.  在**指纹过滤**区域，单击**设置**。

        ![指纹过滤](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1930341061/p169432.png)

    2.  在**指纹过滤特征**页面，单击**添加特征**。

        **说明：** 最多允许添加8条指纹特征规则。

    3.  在**新增指纹过滤特征**页面，完成以下规则配置。

        ![新增指纹过滤特征](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/2930341061/p169433.png)

        |参数|说明|
        |--|--|
        |**协议**|协议类型。可选值：**TCP**、**UDP**。|
        |**开始源端口 — 结束源端口**|源端口范围。可选范围：1~65535。|
        |**开始目的端口 — 结束目的端口**|目的端口范围。可选范围：1~65535。|
        |**最小包长 — 最大包长**|IP数据包的长度范围。可选范围：1~1500，单位：Byte。|
        |**偏移量**|UDP或TCP头部后数据体（payload）的偏移量，可选范围：0~1500，单位：Byte。偏移量为0时，从数据体的第一字节开始匹配。 |
        |**检测载荷**|要匹配的数据体（payload）内容，需要输入以0x开头的十六进制字符串。|
        |**匹配后动作**|匹配中特征后，对流量执行的操作。可选值：**通过**、**丢弃**、**源IP限速**、**session限速**。选择**源IP限速**、**session限速**后，必须设置**限速值**。**限速值**取值范围：1~100000。 |

    4.  单击**确定**。

        成功添加指纹过滤特征后，指纹过滤自动生效，匹配中特征的请求将触发规则对应的动作。您可以在**指纹过滤特征**列表中管理已有特征，例如**编辑**、**删除**特征，或者对特征排序。

        **说明：** 特征排序仅为了方便您管理现有规则，不会对规则生效有任何影响。


